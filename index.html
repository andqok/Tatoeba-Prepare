<!DOCTYPE html>
<html lang="en">
<head>
  <title>Document</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <h1 id="num">0</h1>
    <h1 id="num2">0</h1>
<script src="ui.js"></script>
<script src="util.js"></script>
<script>
    const fs = require('fs')
    
    var langs = ["fra", "spa", "por", "eng", "pol", "ita", "ces", "lat", "tur"]
    //separateLanguages()
    //step4()
    dom.render(ui, document.body)
    langs.forEach(lang => {
        dom.render( lng(lang), query('.langs'))
    })
    click('.step1-submit', e => {
        let langs = queryArr('input[type=checkbox]:checked')
                    .map(el => el.nextSibling.textContent)
        separateLanguages(langs)
    })
    
    function separateLanguages (langs) {
        var active = {}
        var streams = {}
        var count = 0
    
        var sentencesReader = require('readline').createInterface({
            input: require('fs').createReadStream('csv/sentences.csv')
        });
    
        langs.forEach(lang => {
            streams[lang] = fs.createWriteStream(`${lang}.csv`)
        })
    
        sentencesReader.on('line', (line) => {
            line = line.split("\t")
            let num = line[0]
            let lang = line[1]
            let sentence = line[2]
    
            if (langs.includes(lang)) {
                streams[lang].write(num + '\t' + sentence + '\r\n')
                active[line[0]] = line[1]
            }
            count += 1
            if (count % 60000 === 0) {
                id('num').textContent = util.percent(count, 7000000)
            }
        })
    
        sentencesReader.on('close', () => {
            fs.writeFile('active.json', JSON.stringify(active), (e) => { })
            setTimeout(function () {
                step2()
            }, 1000)
        })
    }

    function step2 () {
        let prevIndex = '1'
        let prevTime = 0
        let counterLine = 0
        var currentIndex = 1
        var writeObj = {}
        var linesGroup = []
        var ifLast = false
        var active = util.readFile('active.json')
        let output = fs.createWriteStream('links.json')

        output.write('{')

        var pairReader = require('readline').createInterface({
            input: require('fs').createReadStream('csv/links.csv')
        });

        pairReader.on('line', (line) => {
            if (counterLine % 170000 === 0) {
                id('num2').textContent = util.percent(counterLine, 16000000)
            }
            counterLine += 1
            line = line.split("\t")
            let index1 = +line[0]
            let index2 = +line[1]
            if (active[index1]) {

                if (currentIndex == index1) {
                    linesGroup.push([index1, index2])
                }
                if (index1 > currentIndex) {
                    processGroup()
                    linesGroup = []
                    linesGroup.push([index1, index2])
                    currentIndex = index1
                }
            }

            function processGroup() {
                var result = {}
                for (let line of linesGroup) {
                    var index1 = [line[0]]
                    var index2 = line[1]
                    if (typeof active[index2] !== 'undefined') {
                        result[active[index2] /* e.g. 'eng' */] = index2
                    }
                }
                result = JSON.stringify(result)
                output.write('"' + index1 + '":')
                output.write(result + ',\n')
            }
        })

        pairReader.on('close', () => {
            output.write('"dummy": {}}')
            setTimeout(function () {
                //step3()
            })
        })
    }
    
    function step3 () {
        var links = util.readFile('links.json')

        separateSentences(langs)

        function separateSentences(langs) {

            lang = langs.pop()
            var sentencesReader = require('readline').createInterface({
                input: require('fs').createReadStream('csv/sentences.csv')
            });
            var output = fs.createWriteStream(`garbage-${lang}.json`)
            output.write('{')

            sentencesReader.on('line', (line) => {
                line = line.split("\t")
                var record = {
                    index: line[0],
                    lang: line[1],
                    sentence: line[2]
                }
                if (record.lang === lang) {
                    output.write(`"${record.index}":${JSON.stringify({
                        s: record.sentence,    // sentence
                        o: links[record.index] // others
                    })},\n`)
                }
                //console.log(lang + ' ' + record.index)
            })
            sentencesReader.on('close', () => {
                output.write('"dummy": {}}')
                if (langs.length > 0) {
                    separateSentences(langs)
                }
            })
        }
    }
    
    function step4 () {
        let ex = []
        words('lat', 1)
        function words(lang, num) {
            //ex = []
            var notFiltered = util.readFile(`tmp/garbage-${lang}.json`)
            var tree = {}
            var words = {}
            var mostused = {}
            let res = {}

            for (let key in notFiltered) {

                //if (notFiltered[key]['o'] && notFiltered[key]['o'][otherlang]) {
                //    notFiltered[key]['o'] = notFiltered[key]['o'][otherlang]
                    let sentence = notFiltered[key]['s']
                    if (sentence) {
                        processWords(words, tree, sentence.split(" "), key)
                    }
                //} else {
                //    delete notFiltered[key]
                //}
            }

            for (let key in words) {

                let obj = words[key]
                if (obj.length > 23) {
                    if (mostused[obj.length]) {
                        mostused[obj.length].push(key)
                    } else {
                        mostused[obj.length] = [key]
                    }
                }
            }

            //res['-tree']     = tree
            res['-words'] = words
            //notFiltered['-mostused'] = mostused
            notFiltered['-lang'] = lang
            //console.log(ex)
            fs.writeFileSync(`res/â€”${lang}.js`,
                `var lang${num} = ${JSON.stringify(res)}`)
        }

        function processWords(words, tree, wordsArr, key) {

            for (let word of wordsArr) {
                //if (typeof parseInt(word) !== 'number') {
                word = word.toLowerCase()
                word = util.removePunctuation(word)
                //makeTree(tree, word)
                makeWords(words, word, key)
                //} else {
                //   ex.push(word)
                //}
            }
        }


        function makeWords(words, word, key) {
            if (words[word]) {
                try {
                    words[word].push(key)
                } catch (e) {
                    //console.log(word)
                    //console.log(JSON.stringify(words) + ' error ' + e)
                    ex.push(words[word])
                    //exceptins += 1
                }
            } else {
                words[word] = [key]
            }
        }
    }


</script>
</body>
</html>
