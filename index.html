<!DOCTYPE html>
<html lang="en">
<head>
  <title>Document</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="style.css" rel="stylesheet">
</head>
<body>
<script src="ui.js"></script>
<script src="util.js"></script>
<script>
    const fs = require('fs')
    
    var langs = ["fra", "ukr", "spa", "por", "eng", "pol", "ita", "ces", "lat", "tur"]
    //separateLanguages()
    //step4()
    dom.render(ui, document.body)
    langs.forEach(lang => {
        dom.render( lng(lang), query('.langs'))
    })
    click('.final-step', e => {
        let languages = ['ukr', 'pol']
            for (let l of languages) {
                step5(l)
            }
        })
    click('.step1-submit', e => {
        let languages = queryArr('input[type=checkbox]:checked')
                    .map(el => el.nextSibling.textContent)
        console.log(languages)
        
        separateLanguages(languages)
    })
    
    
    function separateLanguages (languages) {
        var active = {}
        var streams = {}
        var count = 0
        var specialCounters = {}
        languages.forEach(lang => specialCounters[lang] = 0)
    
        var sentencesReader = require('readline').createInterface({
            input: require('fs').createReadStream('csv/sentences.csv')
        });
    
        languages.forEach(lang => {
            streams[lang] = fs.createWriteStream(`${lang}.csv`)
        })
    
        sentencesReader.on('line', (line) => {
            line = line.split("\t")
            let num = line[0]
            let lang = line[1]
            let sentence = line[2]
    
            if (languages.includes(lang)) {
                streams[lang].write(num + '\t' + sentence + '\r\n')
                active[line[0]] = line[1]
                specialCounters[lang] += 1
            }
            count += 1
            if (count % 60000 === 0) {
                id('progress-main').value = util.percent(count, 7000000)
                languages.forEach(lang => {
                    id('count-' + lang).textContent = specialCounters[lang]
                })
            }
        })
    
        sentencesReader.on('close', () => {
            fs.writeFile('active.json', JSON.stringify(active), (e) => { })
            id('progress-main').value = 100
            setTimeout(function () {
                click('.step2-submit', e => {
                    step2(languages)
                })
            }, 100)
        })
    }

    function step2 (languages) {
        // read active.json and output links.json
        var active = util.readFile('active.json')
        let output = fs.createWriteStream('links.json')

        let prevIndex = '1'
        let prevTime = 0
        let counterLine = 0
        var currentIndex = 1
        var writeObj = {}
        var linesGroup = []
        var ifLast = false

        output.write('{')

        var pairReader = require('readline').createInterface({
            input: require('fs').createReadStream('csv/links.csv')
        });

        pairReader.on('line', (line) => {
            if (counterLine % 170000 === 0) {
                id('num2').textContent = util.percent(counterLine, 16000000)
            }
            counterLine += 1
            line = line.split("\t")
            let index1 = +line[0]
            let index2 = +line[1]
            if (active[index1]) {

                if (currentIndex == index1) {
                    linesGroup.push([index1, index2])
                }
                if (index1 > currentIndex) {
                    processGroup()
                    linesGroup = []
                    linesGroup.push([index1, index2])
                    currentIndex = index1
                }
            }

            function processGroup() {
                var result = {}
                for (let line of linesGroup) {
                    var index1 = [line[0]]
                    var index2 = line[1]
                    if (typeof active[index2] !== 'undefined') {
                        result[active[index2] /* e.g. 'eng' */] = index2
                    }
                }
                result = JSON.stringify(result)
                output.write('"' + index1 + '":')
                output.write(result + ',\n')
            }
        })

        pairReader.on('close', () => {
            output.write('"dummy": {}}')
            setTimeout(function () {
                click('.step3-submit', e => {
                    step3(languages)
                }, 100)
            })
        })
    }
    
    function step3 (languages) {
        var links = util.readFile('links.json')

        separateSentences(languages)
        console.log("c'est fini")
        

        function separateSentences(langs) {

            lang = langs.pop()
            var sentencesReader = require('readline').createInterface({
                input: require('fs').createReadStream('csv/sentences.csv')
            });
            var output = fs.createWriteStream(`tmp/garbage-${lang}.json`)
            output.write('{')

            sentencesReader.on('line', (line) => {
                line = line.split("\t")
                var record = {
                    index: line[0],
                    lang: line[1],
                    sentence: line[2]
                }
                if (record.lang === lang) {
                    output.write(`"${record.index}":${JSON.stringify({
                        s: record.sentence,    // sentence
                        o: links[record.index] // others
                    })},\n`)
                }
            })
            sentencesReader.on('close', () => {
                output.write('"dummy": {}}')
                if (langs.length > 0) {
                    separateSentences(langs)
                }
            })
        }
    }
    
    function step4 (langs) {
        let ex = []
        for (let l of langs)
        words('lat', 1)
        
        function words(lang, num) {
            var notFiltered = util.readFile(`tmp/garbage-${lang}.json`)
            var tree = {}
            var words = {}
            var mostused = {}
            let res = {}

            for (let key in notFiltered) {
                let sentence = notFiltered[key]['s']
                if (sentence) {
                    processWords(words, tree, sentence.split(" "), key)
                }
            }

            for (let key in words) {

                let obj = words[key]
                if (obj.length > 23) {
                    if (mostused[obj.length]) {
                        mostused[obj.length].push(key)
                    } else {
                        mostused[obj.length] = [key]
                    }
                }
            }

            res['-words'] = words
            notFiltered['-lang'] = lang
            fs.writeFileSync(`res/â€”${lang}.js`,
                `var lang${num} = ${JSON.stringify(res)}`)
        }

        function processWords(words, tree, wordsArr, key) {

            for (let word of wordsArr) {
                word = word.toLowerCase()
                word = util.removePunctuation(word)
                makeWords(words, word, key)
            }
        }


        function makeWords(words, word, key) {
            if (words[word]) {
                try {
                    words[word].push(key)
                } catch (e) {
                    ex.push(words[word])
                }
            } else {
                words[word] = [key]
            }
        }
    }
    
    function step5(lang) {
        var notFiltered = require('readline').createInterface({
            input: require('fs').createReadStream(`tmp/garbage-${lang}.json`)
        })

        var counter = 999
        var res

        notFiltered.on('line', line => {
            counter += 1
            if (counter === 1000) {
                let number = line.match(/(?<=")(.*)(?=":{"s":)/)[0]
                res = fs.createWriteStream(`language/${lang}-${number}.json`)
                counter = 0
            }
            res.write(line + '\r\n')
        })
        return true
    }
    function find(newNum, lang) {
        var a = []
        fs.readdirSync('./language/')
            .filter(str => str.includes(lang))
            .map(el => {
                return el.slice(0, el.length - 5).slice(4, 99)
            }).forEach(el => {
                a.push(+el)
            })
        a = a.sort((x, y) => x - y)
        let b = Array.from(a)
        b.push(newNum)
        b.sort((x, y) => x - y)
        b = b.indexOf(newNum)
        let index = a[b - 1]
        var lines = require('readline').createInterface({
            input: require('fs').createReadStream(`language/${lang}-` + index + '.json')
        })
        lines.on('line', line => {
            if (line.includes(newNum + '')) {
                console.log(line)
            }
        })
    }

</script>
</body>
</html>
